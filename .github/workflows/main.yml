name: Build, Push to DockerHub, and Deploy to Azure

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch
  pull_request:
    branches:
      - main

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/beesafeapi:latest .

      - name: Push Docker Image to DockerHub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/beesafeapi:latest

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build-and-push  # This job runs after the build-and-push job

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Container Instance using ARM Template
        run: |
          az group deployment create \
            --resource-group "BeeSafe" \
            --template-file ./azure-deployment-template.json \
            --parameters \
                containerName="test" \
                location="uksouth" \
                imageType="Private" \
                imageName="hertleerlouis/beesafeapi:latest" \
                osType="Linux" \
                numberCpuCores="1" \
                memory="1" \
                restartPolicy="OnFailure" \
                sku="Standard" \
                imageRegistryLoginServer="docker.io" \
                imageUsername="${{ secrets.DOCKER_USERNAME }}" \
                imagePassword="${{ secrets.DOCKER_PASSWORD }}" \
                ipAddressType="Public" \
                ports="[ { \"port\": \"80\", \"protocol\": \"TCP\" } ]" \
                dnsNameLabel="beesafetest" \
                workspaceRegion="uksouth" \
                workspaceSubId="e0287f02-4e4c-455c-9c20-adcb24d4c331" \
                workspaceResourceGroupName="BeeSafe" \
                workspaceName="workspacebeesafe8420"

      - name: Get Public IP Address
        run: |
          echo "Getting public IP address of deployed container..."
          az container show \
            --name test \
            --resource-group "BeeSafe" \
            --query "ipAddress.ip" \
            --output tsv
